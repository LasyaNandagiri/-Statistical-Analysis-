---
title: "Treatment_effectiveness"
author: "Lasya Nandagiri"
date: "2024-11-23"
output:
  pdf_document: default
  html_document:
    includes:
      in_header: header.html
    css: ./lab.css
    highlight: pygments
    theme: cerulean
    toc: true
    toc_float: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r loading-libraries, include=FALSE}
library(tidyverse)
library(openintro)
library(infer)
library(ggplot2)
library(rpart)
library(rpart.plot)

set.seed(2024)

```

```{r - load-dataset, include=FALSE}
study_dataset <- read.csv("AIDS_Clinical_Trials_Group_Study_175.csv")

```

```{r - efficacy-features-addition, include=FALSE}
study_dataset <- study_dataset %>% 
    mutate(diff_cd4_from_baseline = 
             study_dataset$cd420 - study_dataset$cd40,
           immunity_cd4_by_cd8_at_baseline = 
             round(study_dataset$cd40/study_dataset$cd80,2),
           immunity_cd4_by_cd8_at_20_weeks = 
             round(study_dataset$cd420/study_dataset$cd820,2)
           ) %>% 
    mutate(diff_immunity_cd4_by_cd8 =
             immunity_cd4_by_cd8_at_20_weeks - immunity_cd4_by_cd8_at_baseline)

```

---

## Understanding Data and context

```{r cid-distribution}
study_dataset$cid = as.factor(study_dataset$cid)
plot_data <- study_dataset %>%
              group_by(cid,) %>%
              summarise(count = n(), .groups = "drop") %>%
              mutate(proportion = count / sum(count)) %>%
              ungroup()

ggplot(data = plot_data
         , aes(x = cid, y = count, fill = cid)) +
    geom_bar(stat = "identity", position = "stack") +
    geom_text(aes(label = scales::percent(proportion, accuracy = 0.1)),
              position = position_stack(vjust = 0.5), color = "black"
              , size = 8) +
    geom_text(aes(label = count),
              position = position_stack(vjust = 0.85), color = "white"
              , size = 8) +
    scale_fill_manual(values = c("violet", "orange"), 
                    name = "cid", 
                    labels = c("censored", "dead"))+
    ggtitle(paste("Distribution of survival outcome")) +
    ylab(paste("count")) + 
    xlab("Survival Outcome(cid)")

```

```{r trt-distribution}
study_dataset$trt = as.factor(study_dataset$trt)
plot_data <- study_dataset %>%
              group_by(trt,) %>%
              summarise(count = n(), .groups = "drop") %>%
              mutate(proportion = count / sum(count)) %>%
              ungroup()

ggplot(data = plot_data
         , aes(x = trt, y = count, fill = trt)) +
    geom_bar(stat = "identity", position = "stack") +
    geom_text(aes(label = scales::percent(proportion, accuracy = 0.1)),
              position = position_stack(vjust = 0.5), color = "black"
              , size = 7) +
    geom_text(aes(label = count),
              position = position_stack(vjust = 0.85), color = "white"
              , size = 7) +
    scale_fill_manual(values = c("coral", "tan", "thistle", "brown1"), 
                    name = "Treatment Groups", 
                    labels = c("ZDV only", "ZDV + ddI", 
                               "ZDV + Zal", "ddI only"))+
    ggtitle(paste("Distribution of Treatment Groups")) +
    ylab(paste("count")) + 
    xlab("Treatment Groups")

```


```{r func-numerical-variables-summary-across-trt-group}

num_var_summary_across_trt_group_func <- function(y_var, grp_var){
  
  
  y_var <- sym(y_var)
  grp_var <- sym(grp_var)
  
  grp_numerical_summary <- study_dataset %>%
                        select(!!grp_var,!!y_var) %>%
                        group_by(!!grp_var) %>%
                        summarise(grp_min = min(!!y_var)
                                ,grp_25_p = quantile(!!y_var,0.25)
                                ,grp_mean = mean(!!y_var)
                                ,grp_median = median(!!y_var)
                                ,grp_75_p = quantile(!!y_var,0.75)
                                ,grp_max = max(!!y_var)
                                ,grp_sd = sd(!!y_var)
                                ,n = n()
                                )
  return(grp_numerical_summary)
}

num_var_summary_func <- function(y_var){
  
  y_var <- sym(y_var)
  
  numerical_summary <- study_dataset %>%
                        select(!!y_var) %>%
                        summarise(min = min(!!y_var)
                                ,v_25_p = quantile(!!y_var,0.25)
                                ,mean = mean(!!y_var)
                                ,median = median(!!y_var)
                                ,v_75_p = quantile(!!y_var,0.75)
                                ,max = max(!!y_var)
                                ,sd = sd(!!y_var)
                                ,n = n()
                                )
  return(numerical_summary)
}

```

```{r}
print(num_var_summary_func("diff_cd4_from_baseline"))


print(num_var_summary_across_trt_group_func("diff_cd4_from_baseline", "cid"))

print(num_var_summary_func("diff_immunity_cd4_by_cd8"))


print(num_var_summary_across_trt_group_func("diff_immunity_cd4_by_cd8", "cid"))
```

---

## Chi-Square Test on cid with respect to treatment

Null Hypothesis (H0):
  
  There is no association between treatment type (trt) and survival outcome (cid). The distribution of survival outcomes is independent of the treatment group.
  
Alternative Hypothesis (HA):
  There is some association between treatment type (trt) and survival outcome (cid). The type of treatment given has some effect on the survival outcome. The distribution of survival outcomes depends on the treatment group.

```{r contingency-cid-trt}

contingency_table <- table(study_dataset$cid, study_dataset$trt)

dimnames(contingency_table) <- list(cid = c("Censored(0)", "Deceased(1)"),
                     treatment = c("ZDV only", "ZDV + ddI", "ZDV + Zal", "ddI only"))

print(contingency_table)

```


```{r chi-sq-test-cid-trt}

# Chi-Square Test
chi_result <- chisq.test(contingency_table)

chi_result

critical_value <- qchisq(0.95, df = 3)
print(critical_value)

```


```{r full-contingency-table-cid-trt}

contingency_table_with_exp <- contingency_table; 
contingency_table_with_exp[] <- paste(contingency_table,
                                      paste0("(",round(chi_result$expected,2)
                                             ,")"))

contingency_table_with_exp

```

```{r Chi-sq-critical-region}
# Parameters
chi_stat <- 37.354
df <- 3
p_value <- 3.872e-08

# Critical value
critical_value <- qchisq(1 - p_value, df)

# Generate x values for the plot
x <- seq(0, chi_stat + 10, length.out = 500)

# Chi-squared density
y <- dchisq(x, df)

# Plot the chi-squared distribution
png("chi_square_distribution.png", width = 800, height = 400)

plot(x, y, type = "l", lwd = 2, col = "blue",
     xlab = expression(chi^2), ylab = "Density",
     main = paste("Chi-Square Distribution (df =", df, ")"))
abline(v = chi_stat, col = "red", lwd = 2, lty = 2)

# Shade the critical area
critical_region <- x >= critical_value
polygon(c(x[critical_region], rev(x[critical_region])),
        c(y[critical_region], rep(0, sum(critical_region))),
        col = rgb(1, 0, 0, 0.5), border = NA)

# Annotate the critical F-value
text(critical_value + 0.5, max(y) / 2, labels = bquote(Chi[crit] == .(round(critical_value, 2))),
     col = "red", cex = 1.2, pos = 4)

# Add a horizontal line at y = 0 for better visualization
abline(h = 0, col = "black", lwd = 1)

dev.off()
```


---

## ANOVA cd4 difference between baseline and 20 weeks


```{r group-summary-cd4-diff}

group_summary_statistics_cd4_diff <- study_dataset %>%
  group_by(trt) %>%
  summarise(average = mean(`diff_cd4_from_baseline`, na.rm = TRUE),
            sd = sd(`diff_cd4_from_baseline`, na.rm = TRUE),
            sample_size = n())

group_summary_statistics_cd4_diff

```

```{r plot-boxplots-cd4-diff}
# Boxplot for Variance Check
ggplot(study_dataset, aes(x = as.factor(trt), y = `diff_cd4_from_baseline`,
                          fill = as.factor(trt))) +
  geom_boxplot(outlier.color = "black", outlier.shape = 16, 
               outlier.size = 2) +
  scale_fill_manual(values = c("red", "green", "blue", "purple"), 
                    name = "Treatment Groups", 
                    labels = c("ZDV only", "ZDV + ddI", 
                               "ZDV + Zal", "ddI only")) +
  labs(title = "Difference in cd4 count after 20 weeks vs Treatment Group",
       x = "Treatment Group",
       y = "Difference in cd4 count") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
        axis.title.x = element_text(size = 12),
        axis.title.y = element_text(size = 12),
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 10))
```


```{r plot-histograms-cd4-diff}


#histograms for each treatment group
ggplot(study_dataset, aes(x = `diff_cd4_from_baseline`, 
                          fill = as.factor(trt))) +
  geom_histogram(bins = 15, color = "black", alpha = 0.7) +
  facet_wrap(~trt, labeller = labeller(trt = c("0" = "ZDV only", 
                                               "1" = "ZDV + ddI", 
                                               "2" = "ZDV + Zal", 
                                               "3" = "ddI only"))) +
  scale_fill_manual(values = c("red", "green", "blue", "purple")) +
  labs(title = "Histogram of difference in cd4 count after 20 weeks by Treatment Group",
       x = "Difference in cd4 count",
       y = "Frequency",
       fill = "Treatment Group") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
        axis.title.x = element_text(size = 12),
        axis.title.y = element_text(size = 12),
        legend.position = "none")

```

```{r anova-cd4-diff}
# Perform ANOVA
anova_result_cd4_diff <- aov(`diff_cd4_from_baseline` ~ as.factor(trt),
                    data = study_dataset)

# Summarize ANOVA results
summary(anova_result_cd4_diff)

```


```{r ANOVA distribution plot}

# Define parameters
df1 <- 3   # Replace with your treatment degrees of freedom
df2 <- 2135  # Replace with your residual degrees of freedom
alpha <- 0.05  # Significance level

# Calculate the critical F-value
critical_value <- qf(1 - alpha, df1, df2)

# Generate x values for the F-distribution
x <- seq(0, critical_value + 5, length.out = 500)

# F-distribution density
y <- df(x, df1, df2)

png("ANOVA_cd4_distribution.png", width = 800, height = 400)
# Plot the F-distribution
plot(x, y, type = "l", lwd = 2, col = "blue",
     xlab = expression(F), ylab = "Density",
     main = paste("F-Distribution (df1 =", df1, ", df2 =", df2, ")"))

# Shade the critical area
critical_region <- x >= critical_value
polygon(c(x[critical_region], rev(x[critical_region])),
        c(y[critical_region], rep(0, sum(critical_region))),
        col = rgb(1, 0, 0, 0.5), border = NA)

# Add a vertical line for the critical F-value
abline(v = critical_value, col = "red", lwd = 2, lty = 2)

# Annotate the critical F-value
text(critical_value + 0.5, max(y) / 2, labels = bquote(F[crit] == .(round(critical_value, 2))),
     col = "red", cex = 1.2, pos = 4)

dev.off()


```


```{r bonferroni-corrections}
# Get unique treatment pairs
  treatments <- unique(study_dataset$trt)
  pairs <- combn(levels(study_dataset$trt), 2, simplify = FALSE)
  
  # Number of comparisons
  num_comparisons <- length(pairs)
  
  # Bonferroni-adjusted alpha
  alpha <- 0.05
  alpha_adjusted <- alpha / num_comparisons
  
  # Perform one-sided t-tests for each pair
  results <- lapply(pairs, function(pair) {
    group1 <- study_dataset[study_dataset$trt == pair[1], "diff_cd4_from_baseline"]
    group2 <- study_dataset[study_dataset$trt == pair[2], "diff_cd4_from_baseline"]
    
    # Perform one-sided t-test (group1 > group2)
    t_test <- t.test(group1, group2, alternative = "two.sided", var.equal= TRUE)
    
    # Store results
    list(
      Treatment1 = pair[1],
      Treatment2 = pair[2],
      t_statistic = t_test$statistic,
      p_value = t_test$p.value,
      Significant = t_test$p.value < alpha_adjusted
    )
  })
  
  # Convert results to a data frame
  results_df <- do.call(rbind, lapply(results, as.data.frame))
  
  # Display results
  print(results_df)

```


---

## ANOVA Immunity difference between baseline and 20 weeks

Immunity = cd4 count/cd8 count

```{r group-summary-immunity}

group_summary_statistics_immunity <- study_dataset %>%
  group_by(trt) %>%
  summarise(average = mean(`diff_immunity_cd4_by_cd8`, na.rm = TRUE),
            sd = sd(`diff_immunity_cd4_by_cd8`, na.rm = TRUE),
            sample_size = n())

group_summary_statistics_immunity
```


```{r plot-boxplots-immunity}
# Boxplot for Variance Check
ggplot(study_dataset, aes(x = as.factor(trt), y = `diff_immunity_cd4_by_cd8`,
                          fill = as.factor(trt))) +
  geom_boxplot(outlier.color = "black", outlier.shape = 16, 
               outlier.size = 2) +
  scale_fill_manual(values = c("red", "green", "blue", "purple"), 
                    name = "Treatment Groups", 
                    labels = c("ZDV only", "ZDV + ddI", 
                               "ZDV + Zal", "ddI only")) +
  labs(title = "Immunity vs Treatment Group",
       x = "Treatment Group",
       y = "Immunity") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, size = 10, face = "bold"),
        axis.title.x = element_text(size = 9),
        axis.title.y = element_text(size = 9),
        legend.title = element_text(size = 8),
        legend.text = element_text(size = 8))
```

```{r plot-histograms-immunity}


#histograms for each treatment group
ggplot(study_dataset, aes(x = `diff_immunity_cd4_by_cd8`, 
                          fill = as.factor(trt))) +
  geom_histogram(bins = 50, color = "black", alpha = 0.7) +
  facet_wrap(~trt, labeller = labeller(trt = c("0" = "ZDV only", 
                                               "1" = "ZDV + ddI", 
                                               "2" = "ZDV + Zal", 
                                               "3" = "ddI only"))) +
  scale_fill_manual(values = c("red", "green", "blue", "purple")) +
  labs(title = "Histogram of Immunity by Treatment Group",
       x = "Immunity",
       y = "Frequency",
       fill = "Treatment Group") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, size = 10, face = "bold"),
        axis.title.x = element_text(size = 9),
        axis.title.y = element_text(size = 9),
        legend.position = "none")

```


---

## CART Method for features importance

```{r func-box-plot-across-trt-group}

box_plot_across_trt_group_func <- function(y_var, y_axis_name, group_var){
  
  y_var <- sym(y_var)  
  group_var <- sym(group_var)
  
ggplot(study_dataset, aes(x=as.factor(!!group_var), y=!!y_var, color=as.factor(!!group_var))) +
  geom_boxplot() +
  scale_color_hue(c = 40) + 
  ggtitle(paste(y_axis_name, "vs cid")) + 
  ylab(y_axis_name) + 
  xlab("cid") +
    theme_minimal()+
    theme(
      plot.title = element_text(size = 10),    # Title font size
      axis.title.x = element_text(size = 6), # X-axis label font size
      axis.title.y = element_text(size = 6)  # Y-axis label font size
    )
}


box_plot_across_trt_group_func("age", "Age", "cid")

box_plot_across_trt_group_func("wtkg", "Weight", "cid")


```

```{r func-bar-graph-with-category-across-trt-group, fig.align = 'center', fig.height=4}

bar_graph_cat_var_across_trt_group_func <- function(y_var, y_axis_name, grp_var){

  y_var <- sym(y_var)
  grp_var <- sym(grp_var)
  # Calculate proportions
  plot_data <- study_dataset %>%
    group_by(!!grp_var, !!y_var) %>%
    summarise(count = n(), .groups = "drop") %>%
    group_by(!!grp_var) %>%
    mutate(proportion = count / sum(count)) %>%
    ungroup()
  
  # Create the bar graph with proportions as labels
  ggplot(data = plot_data
         , aes(x = !!grp_var, y = proportion, fill = as.factor(!!y_var))) +
    geom_bar(stat = "identity", position = "stack") +
    geom_text(aes(label = scales::percent(proportion, accuracy = 0.1)),
              position = position_stack(vjust = 0.5), color = "black"
              , size = 3) +
    ggtitle(paste("Proportion of", y_axis_name, "VS CID")) +
    ylab(paste("Proportion of", y_axis_name)) + 
    xlab("CID") +
    scale_fill_discrete(name = y_axis_name) +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
    theme_minimal()+
    theme(
      plot.title = element_text(size = 10),    # Title font size
      axis.title.x = element_text(size = 6), # X-axis label font size
      axis.title.y = element_text(size = 6)  # Y-axis label font size
    )
}

bar_graph_cat_var_across_trt_group_func("gender", "Gender", "cid")

bar_graph_cat_var_across_trt_group_func("race", "Race", "cid")

```



```{r }

# study_dataset$cid = as.factor(study_dataset$cid)
# treefit <- rpart(cid ~  gender, method = "class", data = study_dataset)
# rpart.plot(treefit); text(treefit, cex=0.75)


# Convert necessary variables to factors (if applicable)
study_dataset$cid <- as.factor(study_dataset$cid)
study_dataset$race <- as.factor(study_dataset$race)
study_dataset$gender <- as.factor(study_dataset$gender)
study_dataset$drugs <- as.factor(study_dataset$drugs)

# Build the decision tree model
decision_tree <- rpart(cid ~  ., 
                       data = study_dataset[,c("age","wtkg","race",
                                             "gender","drugs","homo","hemo"
                                             ,"cid")], 
                      )

# Plot the decision tree
rpart.plot(decision_tree)

# Print the decision tree details
printcp(decision_tree)  # Display the complexity parameter table
summary(decision_tree)  # Display the summary of the model


```



```{r}

# Fit logistic regression model
logistic_model <- glm(cid ~ age + race + gender + wtkg + hemo + homo + drugs, 
                      data = study_dataset, 
                      family = binomial(link = "logit"))

# Summary of the logistic regression model
summary(logistic_model)

# Evaluate model fit using pseudo R-squared
library(pscl)
pR2(logistic_model)
```


```{r}
ggplot(study_dataset, aes(x=as.factor(cid),fill=as.factor(cid))) +
 geom_bar( )+
 scale_fill_discrete(name="Censored flag",
 breaks=c(0,1),
 labels=c("Censored","Dead"))
```

